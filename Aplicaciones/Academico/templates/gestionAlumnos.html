{% extends "./base.html" %}
{% block title %} Gestion de alumnos {% endblock %}

{% block body %}
<div class="row">
    <div class="col-sm-12 col-md-6 col-lg-4 col-xl-4">
        <!--
       {% if messages %}
        {% for message in messages %}
        <div class="alert alert-dismissible alert-success">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          <strong class="text-dark">{{ message }}</strong>
        </div>
        {% endfor %}
      {% endif %}
        -->
        
        <h2 class="text-center" style="margin-top: 20px;">Gestion de alumnos</h2>
        <div class="card">
            <div class="card-body" style="display: flex;
                                        justify-content: flex-start;
                                        flex-direction: column-reverse;">
                <form id="formularioAlumno" enctype="multipart/form-data" action="/registrarAlumno/" method="POST"> {% csrf_token %}
                    <div class="form-group" style="margin: 10px;">
                        <input type="text" 
                                name="txtNUA" 
                                id="txtNUA" 
                                class="form-control" 
                                placeholder="NUA" 
                                minlength="6" 
                                maxlength="6" 
                                required>
                    </div>
                    <div class="form-group" style="margin: 10px;">
                        <input type="text" 
                                name="txtNombre" 
                                id="txtNombre" 
                                class="form-control" 
                                placeholder="Nombre del alumno (Apellidos - Nombre(s))"
                                minlength="3" 
                                maxlength="100" 
                                required>
                    </div>
                    <div class="form-group" style="margin: 10px;">
                        <label for="foto">Foto del Alumno(a): </label>
                        <input type="file" id="foto" name="fotoAlumno" accept="image/*">
                    </div>
                    <div class="form-group" style="display: flex; padding-left: 10px;">
                        <button type="submit" class="btn btn-success btn-block text-white btnGuardar">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-sm-12 col-md-6 col-lg-8 col-xl-8">
        <h1 class="text-center">Listado de alumnos</h1>
        <div class="table-responsive py-2">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>NUA</th>
                        <th>Alumno</th>
                        <th colspan="2">Opciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in alumnos %}
                    <tr>
                        <td>{{forloop.counter}}</td>
                        <td>{{a.nua}}</td>
                        <td>{{a.nombre}}</td>
                        <td>
                            <a href="edicionAlumno/{{a.nua}}" class="btn btn-info">Editar</a>
                            <a href="eliminacionAlumno/{{a.nua}}" class="btn btn-danger btnEliminacion">Eliminar</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script src="https://kit.fontawesome.com/817e16562f.js" crossorigin="anonymous"></script>
<!--Sweet Alert-->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

    const noificationSwal = (titleText, text, icon, confirmButtonText) => {
        Swal.fire({
            titleText: titleText,
            text: text,
            icon: icon, // warning, error, success, info
            confirmButton: confirmButtonText
        });
    }
    //noificationSwal(document.title, "Alumnos listados con éxito", "success", "Ok")

    formularioAlumno.addEventListener("submit", function (e) {
        let nombre = String(txtNombre.value).trim()

        if (nombre.length < 3) {
            noificationSwal(document.title, "El nombre del alumno no puede ir vacio...", "warning", "Ok")
            e.preventDefault()
        } else {
            let nua = parseInt(nua.value)
            if (nua.length < 6 || nua.length > 6) {
                noificationSwal(document.title, "El NUA debe contener 6 números...", "warning", "Ok")
                e.preventDefault()
            }
        }
    })

    const btnEliminacion = document.querySelectorAll(".btnEliminacion")
    const formGuardar = document.querySelector("#formularioAlumno");
    const btnGuardar = document.querySelector(".btnGuardar")

    btnEliminacion.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault()
            Swal.fire({
                title: "¿Estas seguro(a) que deseas eliminar a esta persona?",              
                text: "No podrás revertir esta acción!",
                icon: "warning",
                showCancelButton: true, 
                confirmButtonText: "Sí, Eliminar",
                confirmButtonColor: "#d33",
                backdrop: true,
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    //console.log("Confirmado!!!!")
                    location.href = e.target.href;
                },
                allowOutsideClick: () => false,
                allowEscapeKey: () => false
            })
        })
    })

    formGuardar.addEventListener('submit', (e) => {
        e.preventDefault(); // Evita el envío normal del formulario

        Swal.fire({
            position: "center",
            icon: "success",
            title: "El alumno ha sido guardado!!",
            showConfirmButton: false,
            timer: 1500
        }).then((result) => {
            // Realiza la acción del formulario después de mostrar la alerta de éxito
            if (result.dismiss === Swal.DismissReason.timer) {
                // La alerta se cerró automáticamente (pasaron 1500 ms)
                // Aquí puedes ejecutar la acción del formulario
                formGuardar.submit(); // Envía el formulario
            }
        });
    });


</script>

{% endblock %}